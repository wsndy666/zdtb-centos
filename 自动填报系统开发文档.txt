# 自动填报系统开发文档

## 一、系统概述

### 1.1 开发目标
根据提供的文档、表格等固定的模板自动生成填报材料，实现自动化。实现模板与项目数据的高效管理，通过变量复用、自动填充等功能，减少重复操作，确保填报材料生成的准确性和效率。

### 1.2 核心价值
- 变量数据库实现“一次定义、多模板复用”，解决相同信息重复录入问题。
- 首页集中展示项目数据，简化“选项目→选模板→生成文件”流程。
- 支持数据导入导出、操作记录追踪，满足办公场景中的数据管理需求。


## 二、核心功能模块设计

### 2.1 变量数据库模块

#### 2.1.1 设计逻辑
- **唯一性存储**：以“变量名称”为唯一标识，例如“项目名称”在数据库中仅保留1条记录，所有模板共享该变量。
- **核心属性**：

| 属性         | 说明                          | 示例                          |
|--------------|-------------------------------|-------------------------------|
| 变量名称     | 唯一标识，供模板调用          | 项目名称、合同编号            |
| 数据类型     | 限制录入格式                  | 字符串、数字、日期            |
| 示例值       | 提示用户录入格式              | 5G智慧矿山系统项目、CMHA-HB-202300215 |
| 是否必填     | 控制所有模板中该变量的必填性  | 是/否                         |
| 关联模板列表 | 记录引用该变量的模板          | 模板1、模板2                  |

#### 2.1.2 与模板的关联规则
- 模板上传时，系统自动提取占位符（`{{变量名}}`），查询变量数据库：
  - 若变量已存在，直接关联；
  - 若不存在，提示用户创建并加入数据库，供后续模板复用。

#### 2.1.3 变量格式样板
**标准格式：** `{{变量名}}`

**常用变量示例：**
- `{{填报项目名称}}` - 项目的名称（系统固定列，避免与用户变量冲突）
- `{{备注说明}}` - 备注说明信息（系统固定列，避免与用户变量冲突）
- `{{系统项目名称}}` - 旧版本的项目名称（已更名为填报项目名称）
- `{{系统合同编号}}` - 旧版本的合同编号（已更名为备注说明）
- `{{项目名称}}` - 用户自定义的项目名称变量
- `{{合同编号}}` - 用户自定义的合同编号变量  
- `{{申请人}}` - 申请人姓名
- `{{申请日期}}` - 申请的日期
- `{{金额}}` - 申请金额
- `{{部门}}` - 申请部门
- `{{联系电话}}` - 联系电话
- `{{邮箱地址}}` - 邮箱地址

**格式要求：**
- 必须使用英文双大括号 `{{` 和 `}}`
- 变量名不能包含特殊字符（如：@#$%^&*等）
- 变量名建议使用中文，便于理解和维护
- 变量名区分大小写

**错误示例：**
- `{项目名称}` - 单大括号（错误）
- `【项目名称】` - 中文方括号（错误）
- `{{项目@名称}}` - 包含特殊字符（错误）
- `<项目名称>` - 尖括号（错误）


### 2.2 模板管理模块

#### 2.2.1 模板创建流程
1. **上传文件**：用户在“模板管理”页面点击“上传模板”，选择本地含`{{变量名}}`占位符的文件（如`.docx`、`.xls`）。
2. **提取变量**：系统自动扫描并展示占位符（如`{{合同编号}}`），自动关联变量数据库中的变量。
3. **自定义名称**：用户可修改模板名称（默认使用原文件名），点击“保存模板”，文件存储至`./templates`目录，模板列表同步更新。

#### 2.2.2 模板列表展示

| 模板ID | 模板名称                  | 关联变量数 | 支持文件格式 | 操作       |
|--------|---------------------------|------------|--------------|------------|
| T001   | 5G智慧矿山付款说明        | 8          | .docx        | 编辑/删除  |
| T002   | 集成费资金付款通知单      | 10         | .xls         | 编辑/删除  |


### 2.3 项目数据管理模块

#### 2.3.1 首页项目展示
- **页面布局**：顶部为功能入口（模板管理、数据库管理等），中间为“项目数据列表”，底部为“导入数据”“新建项目”按钮。
- **列表内容**：

| 项目ID | 填报项目名称     | 备注说明          | 最近操作时间       | 关联模板数 | 操作       |
|--------|------------------|-------------------|--------------------|------------|------------|
| P001   | 5G智慧矿山系统项目 | CMHA-HB-202300215 | 2025-07-11 14:30   | 3          | 选择项目   |

#### 2.3.2 数据导入与新建
- **导入数据**：点击“导入数据”，选择Excel/CSV文件（每行对应一个项目的完整信息），系统校验后录入数据库，首页列表实时更新。
- **新建项目**：点击“新建项目”，弹出含变量数据库字段的表单（如项目名称、合同编号），填写后保存，数据存入数据库并展示在首页。


### 2.4 文件生成模块

#### 2.4.1 操作流程
1. **选择项目**：在首页点击项目后的“选择项目”按钮，弹出“模板选择”弹窗。
2. **选择模板**：弹窗展示所有模板及变量匹配情况（如“该模板需8个变量，项目已含6个，需补充2个”）。
3. **生成文件**：
   - 数据完整：点击“生成文件”，系统自动填充数据至模板，文件保存至`./output/项目ID/模板名称/`。
   - 数据缺失：弹窗提示缺失字段（如“请补充{{发票号码}}”），用户填写后重新生成。


### 2.5 数据库导入导出模块

#### 2.5.1 导入功能
- 支持Excel/CSV格式，导入时自动匹配字段（如“合同编号”对应数据库字段），校验重复数据和格式（如金额为数字），异常数据标记并提示用户修正。

#### 2.5.2 导出功能
- 用户可选择导出“变量数据库”“项目数据”或“指定项目关联数据”，格式为Excel/CSV，文件保存至本地。


### 2.6 操作记录模块
- **日志内容**：记录所有关键操作，包括模板上传、项目创建、文件生成等，格式为：
  - “2025-07-11 10:00 张三上传模板T001”
  - “2025-07-11 15:00 李四选择项目P001，使用模板T002生成文件”
- **查看入口**：点击主界面“操作日志”，按时间倒序展示，支持搜索和筛选。


## 三、页面操作说明

### 3.1 登录与首页
- 登录系统后，默认进入“项目数据列表”首页，可直接查看所有项目，点击功能按钮跳转至对应模块。

### 3.2 模板管理页面
- 展示所有模板，支持上传、编辑、删除操作，点击模板名称可查看关联的变量详情。

### 3.3 数据库管理页面
- 分为“变量数据库”和“项目数据库”标签：
  - 变量数据库：展示所有变量及关联模板，支持编辑变量属性。
  - 项目数据库：展示所有项目的完整信息，支持导出、批量删除、编辑单条数据。

### 3.4 文件生成页面（弹窗式）
- 选择项目和模板后，弹窗展示数据匹配情况，支持在线补充缺失数据，生成后提供文件下载链接。


## 四、技术实现要点
- **后端**：Python + Flask，使用`python-docx`、`openpyxl`处理文档，SQLite存储数据。
- **前端**：HTML + Bootstrap，实现响应式页面，支持表格筛选、弹窗交互。
- **数据校验**：通过正则表达式和自定义规则校验数据格式（如金额大写匹配、日期格式）。
- **安全性**：用户操作日志记录，敏感数据加密存储（如数据库导入导出路径）。


## 五、示例流程
1. **创建模板**：上传含`{{合同编号}}`的`5G智慧矿山系统项目-集成.docx`，系统提取变量并关联数据库，保存为模板T001。
2. **导入项目**：导入含“5G智慧矿山系统项目”信息的Excel，首页显示项目P001。
3. **生成文件**：选择P001，在模板弹窗中选择T001，系统自动填充数据生成文件，保存至`./output/P001/T001/`。
4. **查看记录**：在“操作日志”中可追溯项目创建、文件生成的完整流程。


通过以上设计，系统实现了变量复用、项目数据集中管理、模板快速匹配的核心需求，大幅提升报账材料生成效率，减少人工操作错误。