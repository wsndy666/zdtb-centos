# 自动填报系统 - 部署指南

## 系统概述

本系统是一个基于Flask的自动填报系统，支持模板管理、变量数据库、项目数据管理和自动文件生成功能。

## 环境要求

- **操作系统**：Windows 10/11, macOS, Linux
- **Python版本**：Python 3.7 或更高版本
- **内存**：建议 4GB 以上
- **磁盘空间**：建议 1GB 以上可用空间

## 快速部署步骤

### 1. 下载系统文件

将整个项目文件夹复制到目标服务器或本地环境。

### 2. 安装Python环境

确保系统已安装Python 3.7+：
```bash
python --version
```

### 3. 创建虚拟环境（推荐）

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate
```

### 4. 安装依赖包

```bash
pip install -r requirements.txt
```

### 5. 启动系统

```bash
python app.py
```

系统启动后会自动：
- 创建必要的目录（templates、uploads、output）
- 初始化SQLite数据库
- 在浏览器中打开系统界面

### 6. 访问系统

- **本地访问**：http://localhost:5000
- **网络访问**：http://[服务器IP]:5000

## 目录结构说明

```
报账001/
├── app.py                    # 主应用程序
├── requirements.txt          # Python依赖包列表
├── README.md                # 系统说明文档
├── 部署指南.md              # 本部署指南
├── 自动填报系统开发文档.txt  # 详细开发文档
├── templates/               # HTML模板文件
│   ├── base.html           # 基础模板
│   ├── index.html          # 首页
│   ├── templates.html      # 模板管理
│   ├── variables.html      # 变量管理
│   ├── projects.html       # 项目管理
│   ├── data_management.html # 数据管理
│   ├── logs.html           # 操作日志
│   ├── about.html          # 关于页面
│   └── help.html           # 帮助页面
├── static/                  # 静态资源文件
├── uploads/                 # 上传文件存储目录（自动创建）
├── output/                  # 生成文件输出目录（自动创建）
├── system.db               # SQLite数据库文件（自动创建）
└── venv/                   # Python虚拟环境（可选）
```

## 配置说明

### 端口配置

默认端口为5000，如需修改，请编辑 `app.py` 文件末尾：
```python
if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)  # 修改port参数
```

### 文件上传限制

默认最大上传文件大小为16MB，如需修改，请编辑 `app.py` 中的配置：
```python
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB
```

### 数据库配置

系统使用SQLite数据库，数据库文件为 `system.db`，首次运行时自动创建。

## 功能模块说明

### 1. 变量管理
- 统一管理可复用的变量数据
- 支持变量的增删改查
- 变量类型和示例值管理

### 2. 模板管理
- 支持Word(.docx)和Excel(.xlsx)模板上传
- 自动提取模板中的变量
- 模板预览和下载功能

### 3. 项目管理
- 项目数据的创建和管理
- 支持Excel批量导入项目数据
- 项目数据的编辑和删除

### 4. 文件生成
- 基于模板和项目数据自动生成文件
- 支持单个和批量文件生成
- 智能变量匹配和缺失提醒

### 5. 数据管理
- 导出功能：支持变量数据、项目数据导出
- 清理功能：清理生成的文件和日志
- 文件管理：查看和下载生成的文件

### 6. 操作日志
- 记录所有关键操作
- 支持日志筛选和导出
- 操作追踪和审计

## 常见问题解决

### 1. 端口被占用
```
OSError: [Errno 48] Address already in use
```
**解决方案**：修改端口号或关闭占用端口的程序。

### 2. 依赖包安装失败
```
ERROR: Could not find a version that satisfies the requirement
```
**解决方案**：
- 检查Python版本是否符合要求
- 更新pip：`pip install --upgrade pip`
- 使用国内镜像：`pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/`

### 3. 文件上传失败
**可能原因**：
- 文件格式不支持
- 文件大小超过限制
- 文件名包含特殊字符

**解决方案**：
- 检查文件格式（支持.docx, .xlsx, .csv）
- 检查文件大小（默认限制16MB）
- 重命名文件，避免特殊字符

### 4. 数据库错误
```
sqlite3.OperationalError: database is locked
```
**解决方案**：
- 关闭其他可能访问数据库的程序
- 重启系统
- 检查数据库文件权限

## CentOS系统部署指南

### 1. 系统准备

#### 1.1 更新系统
```bash
# 更新系统包
sudo yum update -y

# 安装必要的开发工具
sudo yum groupinstall "Development Tools" -y
sudo yum install -y git wget curl
```

#### 1.2 安装Python 3.7+

**CentOS 7系统：**
```bash
# 安装EPEL仓库
sudo yum install -y epel-release

# 安装Python 3.8
sudo yum install -y python38 python38-pip python38-devel

# 创建软链接（可选）
sudo alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1
sudo alternatives --install /usr/bin/pip3 pip3 /usr/bin/pip3.8 1
```

**CentOS 8/9系统（使用dnf）：**
```bash
# 安装Python 3.8或3.9
sudo dnf install -y python3 python3-pip python3-devel

# 或者安装特定版本
sudo dnf install -y python38 python38-pip python38-devel
```

**验证安装：**
```bash
python3 --version
pip3 --version
```

#### 1.3 创建系统用户
```bash
# 创建专用用户
sudo useradd -m -s /bin/bash autoform
sudo passwd autoform

# 切换到用户目录
sudo su - autoform
```

### 2. 部署应用

#### 2.1 上传项目文件
```bash
# 在用户主目录创建应用目录
mkdir -p /home/autoform/app
cd /home/autoform/app

# 上传项目文件（通过scp、git或其他方式）
# 例如：scp -r /path/to/报账001/* autoform@server_ip:/home/autoform/app/
```

#### 2.2 创建虚拟环境
```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 升级pip
pip install --upgrade pip
```

#### 2.3 安装依赖
```bash
# 安装Python依赖
pip install -r requirements.txt

# 如果安装失败，使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 3. 配置系统服务

#### 3.1 安装Gunicorn
```bash
# 在虚拟环境中安装Gunicorn
pip install gunicorn
```

#### 3.2 创建Gunicorn配置文件
```bash
# 创建配置文件
cat > /home/autoform/app/gunicorn.conf.py << EOF
bind = "0.0.0.0:5000"
workers = 4
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 100
preload_app = True
user = "autoform"
group = "autoform"
tmp_upload_dir = None
EOF
```

#### 3.3 创建systemd服务文件
```bash
# 创建服务文件
sudo tee /etc/systemd/system/autoform.service > /dev/null << EOF
[Unit]
Description=Auto Form System
After=network.target

[Service]
Type=exec
User=autoform
Group=autoform
WorkingDirectory=/home/autoform/app
Environment=PATH=/home/autoform/app/venv/bin
ExecStart=/home/autoform/app/venv/bin/gunicorn -c gunicorn.conf.py app:app
ExecReload=/bin/kill -s HUP \$MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF
```

#### 3.4 启动服务
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启用服务
sudo systemctl enable autoform

# 启动服务
sudo systemctl start autoform

# 检查服务状态
sudo systemctl status autoform
```

### 4. 配置Nginx反向代理

#### 4.1 安装Nginx
```bash
# 安装Nginx
sudo yum install -y nginx

# 启动并启用Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 4.2 配置Nginx
```bash
# 创建站点配置文件
sudo tee /etc/nginx/conf.d/autoform.conf > /dev/null << EOF
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或IP
    
    client_max_body_size 20M;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    location /static {
        alias /home/autoform/app/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
EOF

# 测试配置
sudo nginx -t

# 重新加载Nginx
sudo systemctl reload nginx
```

### 5. 配置防火墙

#### 5.1 配置firewalld
```bash
# 开放HTTP端口
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https

# 如果直接访问应用端口
sudo firewall-cmd --permanent --add-port=5000/tcp

# 重新加载防火墙规则
sudo firewall-cmd --reload

# 查看开放的端口
sudo firewall-cmd --list-all
```

### 6. 设置文件权限
```bash
# 设置应用目录权限
sudo chown -R autoform:autoform /home/autoform/app
sudo chmod -R 755 /home/autoform/app

# 确保数据库文件可写
sudo chmod 664 /home/autoform/app/system.db
sudo chmod 775 /home/autoform/app/uploads
sudo chmod 775 /home/autoform/app/output
```

### 7. 配置日志轮转
```bash
# 创建日志目录
sudo mkdir -p /var/log/autoform
sudo chown autoform:autoform /var/log/autoform

# 创建logrotate配置
sudo tee /etc/logrotate.d/autoform > /dev/null << EOF
/var/log/autoform/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 autoform autoform
    postrotate
        systemctl reload autoform
    endscript
}
EOF
```

### 8. 数据备份脚本
```bash
# 创建备份脚本
sudo tee /home/autoform/backup.sh > /dev/null << 'EOF'
#!/bin/bash
BACKUP_DIR="/home/autoform/backups"
DATE=$(date +%Y%m%d_%H%M%S)
APP_DIR="/home/autoform/app"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
cp $APP_DIR/system.db $BACKUP_DIR/system_$DATE.db

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz -C $APP_DIR uploads/

# 删除30天前的备份
find $BACKUP_DIR -name "*.db" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
EOF

# 设置执行权限
sudo chmod +x /home/autoform/backup.sh
sudo chown autoform:autoform /home/autoform/backup.sh

# 添加到crontab（每天凌晨2点备份）
(crontab -l 2>/dev/null; echo "0 2 * * * /home/autoform/backup.sh") | crontab -
```

### 9. 监控和维护

#### 9.1 查看服务状态
```bash
# 查看应用服务状态
sudo systemctl status autoform

# 查看服务日志
sudo journalctl -u autoform -f

# 查看Nginx状态
sudo systemctl status nginx
```

#### 9.2 重启服务
```bash
# 重启应用服务
sudo systemctl restart autoform

# 重启Nginx
sudo systemctl restart nginx
```

#### 9.3 更新应用
```bash
# 停止服务
sudo systemctl stop autoform

# 备份当前版本
cp -r /home/autoform/app /home/autoform/app_backup_$(date +%Y%m%d)

# 更新代码文件
# 上传新版本文件...

# 更新依赖
source /home/autoform/app/venv/bin/activate
pip install -r requirements.txt --upgrade

# 启动服务
sudo systemctl start autoform
```

### 10. SSL配置（可选）

#### 10.1 使用Let's Encrypt免费证书
```bash
# 安装certbot
sudo yum install -y certbot python3-certbot-nginx
# 或者对于CentOS 8/9
sudo dnf install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 设置自动续期
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

#### 10.2 手动配置SSL
```bash
# 修改Nginx配置文件
sudo tee /etc/nginx/conf.d/autoform.conf > /dev/null << EOF
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    
    client_max_body_size 20M;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
    
    location /static {
        alias /home/autoform/app/static;
        expires 30d;
    }
}
EOF
```

### 11. CentOS系统特殊注意事项

#### 11.1 SELinux配置
```bash
# 检查SELinux状态
getenforce

# 临时禁用SELinux（重启后恢复）
sudo setenforce 0

# 永久禁用SELinux（需要重启）
sudo sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config

# 或者配置SELinux策略（推荐）
sudo setsebool -P httpd_can_network_connect 1
sudo setsebool -P httpd_can_network_relay 1
```

#### 11.2 时区设置
```bash
# 设置时区为中国标准时间
sudo timedatectl set-timezone Asia/Shanghai

# 验证时区设置
timedatectl
```

#### 11.3 系统资源优化
```bash
# 增加文件描述符限制
echo "autoform soft nofile 65536" | sudo tee -a /etc/security/limits.conf
echo "autoform hard nofile 65536" | sudo tee -a /etc/security/limits.conf

# 优化内核参数
sudo tee -a /etc/sysctl.conf > /dev/null << EOF
# 网络优化
net.core.somaxconn = 1024
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 1024
EOF

# 应用内核参数
sudo sysctl -p
```

### 12. 故障排除

#### 12.1 常见问题

**问题1：服务启动失败**
```bash
# 查看详细错误信息
sudo journalctl -u autoform -n 50

# 检查配置文件语法
python3 -c "import app; print('配置正确')"

# 检查端口占用
sudo netstat -tlnp | grep :5000
```

**问题2：Nginx配置错误**
```bash
# 测试Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

**问题3：权限问题**
```bash
# 检查文件权限
ls -la /home/autoform/app/

# 重新设置权限
sudo chown -R autoform:autoform /home/autoform/app
sudo chmod -R 755 /home/autoform/app
```

**问题4：Python依赖问题**
```bash
# 重新安装依赖
source /home/autoform/app/venv/bin/activate
pip install --force-reinstall -r requirements.txt

# 检查缺失的系统库
ldd /home/autoform/app/venv/lib/python3.8/site-packages/*/
```

#### 12.2 性能监控
```bash
# 安装htop监控工具
sudo yum install -y htop
# 或者
sudo dnf install -y htop

# 监控系统资源
htop

# 监控网络连接
ss -tulpn | grep :5000

# 监控磁盘使用
df -h
du -sh /home/autoform/app/*
```

### 13. 部署检查清单

部署完成后，请按以下清单检查：

- [ ] Python 3.7+ 已安装并可用
- [ ] 虚拟环境已创建并激活
- [ ] 所有依赖包已安装
- [ ] 应用服务已启动并运行正常
- [ ] Nginx已配置并运行
- [ ] 防火墙已正确配置
- [ ] 文件权限已正确设置
- [ ] 备份脚本已配置
- [ ] 日志轮转已配置
- [ ] 可以通过浏览器正常访问
- [ ] 文件上传功能正常
- [ ] 文件生成功能正常
- [ ] SSL证书已配置（如需要）

### 14. 快速部署脚本

为了简化部署过程，可以使用以下一键部署脚本：

```bash
#!/bin/bash
# CentOS自动填报系统一键部署脚本

set -e

echo "开始部署自动填报系统..."

# 检测CentOS版本
if [ -f /etc/centos-release ]; then
    CENTOS_VERSION=$(cat /etc/centos-release | grep -oE '[0-9]+' | head -1)
    echo "检测到CentOS $CENTOS_VERSION"
else
    echo "错误：未检测到CentOS系统"
    exit 1
fi

# 更新系统
echo "更新系统包..."
if [ "$CENTOS_VERSION" -ge 8 ]; then
    sudo dnf update -y
    sudo dnf groupinstall "Development Tools" -y
    sudo dnf install -y git wget curl python3 python3-pip python3-devel nginx
else
    sudo yum update -y
    sudo yum groupinstall "Development Tools" -y
    sudo yum install -y epel-release git wget curl nginx
    sudo yum install -y python38 python38-pip python38-devel
fi

# 创建用户
echo "创建应用用户..."
sudo useradd -m -s /bin/bash autoform || true

# 部署应用
echo "部署应用文件..."
sudo -u autoform mkdir -p /home/autoform/app
# 这里需要手动复制应用文件到 /home/autoform/app/

echo "部署脚本执行完成！"
echo "请手动完成以下步骤："
echo "1. 将应用文件复制到 /home/autoform/app/"
echo "2. 运行：sudo -u autoform /home/autoform/app/deploy.sh"
```

## 生产环境部署建议

### 1. 使用WSGI服务器

生产环境建议使用Gunicorn或uWSGI：

```bash
# 安装Gunicorn
pip install gunicorn

# 启动服务
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### 2. 反向代理

使用Nginx作为反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. 数据备份

定期备份SQLite数据库文件和上传的模板文件：

```bash
# 备份数据库
cp system.db backup/system_$(date +%Y%m%d).db

# 备份上传文件
tar -czf backup/uploads_$(date +%Y%m%d).tar.gz uploads/
```

### 4. 日志管理

配置日志轮转和监控：

```python
import logging
from logging.handlers import RotatingFileHandler

# 在app.py中添加
if not app.debug:
    file_handler = RotatingFileHandler('logs/app.log', maxBytes=10240, backupCount=10)
    file_handler.setFormatter(logging.Formatter(
        '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'))
    file_handler.setLevel(logging.INFO)
    app.logger.addHandler(file_handler)
```

## 安全建议

1. **修改默认密钥**：更改 `app.py` 中的 `SECRET_KEY`
2. **文件上传限制**：限制上传文件类型和大小
3. **访问控制**：在生产环境中添加用户认证
4. **HTTPS**：使用SSL证书加密传输
5. **防火墙**：配置适当的防火墙规则

## 技术支持

如遇到技术问题，请检查：
1. 系统日志输出
2. 浏览器控制台错误
3. 网络连接状态
4. 文件权限设置

## 更新升级

1. 备份当前数据
2. 下载新版本文件
3. 更新依赖包：`pip install -r requirements.txt --upgrade`
4. 重启服务

---

**注意**：首次部署时，系统会自动创建管理员账户和示例数据。请及时修改默认配置以确保系统安全。