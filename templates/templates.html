{% extends "base.html" %}

{% block title %}模板管理 - 智汇填报{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">模板管理</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" onclick="uploadTemplate()">
            <i class="bi bi-upload"></i> 上传模板
        </button>
    </div>
</div>

<div class="row">
    {% if templates %}
        {% for template in templates %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card card-hover h-100">
                <div class="card-body">
                    <h5 class="card-title">{{ template[1] }}</h5>
                    <p class="card-text">
                        <small class="text-muted">
                            <i class="bi bi-file-earmark"></i> 文件名: {{ template[2] }}<br>
                            <i class="bi bi-filetype-{{ template[3][1:] }}"></i> 类型: {{ template[3] }}<br>
                            <i class="bi bi-tags"></i> 变量数: {{ template[4] }} 个<br>
                            <i class="bi bi-clock"></i> 创建时间: {{ template[5] }}
                        </small>
                    </p>
                </div>
                <div class="card-footer bg-transparent">
                    <button class="btn btn-outline-primary btn-sm" onclick="viewTemplate({{ template[0] }})">
                        <i class="bi bi-eye"></i> 查看详情
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTemplate({{ template[0] }})">
                        <i class="bi bi-trash"></i> 删除
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-file-earmark-x" style="font-size: 3rem; color: #6c757d;"></i>
                <h4 class="mt-3 text-muted">暂无模板</h4>
                <p class="text-muted">上传第一个模板开始使用系统</p>
                <button class="btn btn-primary" onclick="uploadTemplate()">
                    <i class="bi bi-upload"></i> 上传模板
                </button>
            </div>
        </div>
    {% endif %}
</div>

<!-- 上传模板模态框 -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">上传模板</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="templateFile" class="form-label">选择模板文件</label>
                        <input type="file" class="form-control" id="templateFile" accept=".docx,.doc,.xlsx,.xls,.csv" required>
                        <div class="form-text">支持.docx、.doc、.xlsx、.xls、.csv格式，文件中使用{{变量名}}格式定义变量</div>
                    </div>
                    <div class="mb-3">
                        <label for="templateName" class="form-label">模板名称</label>
                        <input type="text" class="form-control" id="templateName" placeholder="留空则使用文件名">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitUpload()">上传</button>
            </div>
        </div>
    </div>
</div>

<!-- 模板详情模态框 -->
<div class="modal fade" id="templateDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>模板详情</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="templateDetailContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-3 text-muted">正在加载模板详情...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>关闭
                </button>
                <button type="button" class="btn btn-success" id="downloadDataTemplateBtn" style="display: none;">
                    <i class="bi bi-table me-1"></i>下载数据导入模板
                </button>
                <button type="button" class="btn btn-primary" id="downloadTemplateBtn" style="display: none;">
                    <i class="bi bi-download me-1"></i>下载模板
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function uploadTemplate() {
    $('#uploadModal').modal('show');
}

function submitUpload() {
    const fileInput = document.getElementById('templateFile');
    const templateName = document.getElementById('templateName').value;
    const file = fileInput.files[0];
    
    if (!file) {
        alert('请选择文件');
        return;
    }
    
    // 显示上传中状态
    const submitBtn = document.querySelector('#uploadModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = '上传中...';
    submitBtn.disabled = true;
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('template_name', templateName);
    
    fetch('/upload_template', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(`模板上传成功！检测到 ${data.variables.length} 个变量`);
            $('#uploadModal').modal('hide');
            location.reload();
        } else {
            alert('上传失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('上传失败: ' + error.message);
    })
    .finally(() => {
        // 恢复按钮状态
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

function viewTemplate(templateId) {
    // 显示模态框
    $('#templateDetailModal').modal('show');
    
    // 重置内容为加载状态
    document.getElementById('templateDetailContent').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
        </div>
    `;
    
    // 获取模板详情
    fetch(`/get_template_detail/${templateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTemplateDetail(data.template, data.variables);
            } else {
                document.getElementById('templateDetailContent').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('templateDetailContent').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> 加载模板详情失败
                </div>
            `;
        });
}

function displayTemplateDetail(template, variables) {
    const content = `
        <!-- 模板概览卡片 -->
        <div class="bg-gradient-primary text-white p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2"><i class="bi bi-file-earmark-text me-2"></i>${template.name}</h4>
                    <p class="mb-0 opacity-75">${template.filename}</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                        <span class="badge bg-light text-dark px-3 py-2">
                            <i class="bi bi-filetype-${template.file_type.replace('.', '')} me-1"></i>${template.file_type}
                        </span>
                        <span class="badge bg-warning text-dark px-3 py-2">
                            <i class="bi bi-tags me-1"></i>${template.variables_count} 变量
                        </span>
                        <span class="badge bg-success px-3 py-2">
                            <i class="bi bi-folder me-1"></i>${template.project_count} 项目
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 详细信息 -->
        <div class="p-4">
            <div class="row">
                <!-- 基本信息 -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header bg-light border-0">
                            <h6 class="mb-0 text-primary"><i class="bi bi-info-circle me-2"></i>基本信息</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-3 bg-light rounded">
                                        <i class="bi bi-calendar3 text-muted me-3" style="font-size: 1.2rem;"></i>
                                        <div>
                                            <small class="text-muted d-block">创建时间</small>
                                            <strong>${template.created_at}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                                        <i class="bi bi-tags text-primary" style="font-size: 1.5rem;"></i>
                                        <div class="mt-2">
                                            <h5 class="mb-0 text-primary">${template.variables_count}</h5>
                                            <small class="text-muted">变量数量</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                        <i class="bi bi-folder text-success" style="font-size: 1.5rem;"></i>
                                        <div class="mt-2">
                                            <h5 class="mb-0 text-success">${template.project_count}</h5>
                                            <small class="text-muted">使用项目</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 变量列表 -->
                <div class="col-lg-8 mb-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-primary"><i class="bi bi-code-square me-2"></i>模板变量 (${variables.length}个)</h6>
                            ${variables.length > 0 ? '<small class="text-muted">点击变量名复制到剪贴板</small>' : ''}
                        </div>
                        <div class="card-body p-0">
                            ${variables.length > 0 ? `
                                <div class="table-responsive" style="max-height: 400px;">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th class="border-0">变量名</th>
                                                <th class="border-0">类型</th>
                                                <th class="border-0">必填</th>
                                                <th class="border-0">示例值</th>
                                                <th class="border-0">说明</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${variables.map((variable, index) => `
                                                <tr class="${index % 2 === 0 ? 'bg-light bg-opacity-50' : ''}">
                                                    <td class="border-0">
                                                        <code class="variable-name bg-primary bg-opacity-10 text-primary px-2 py-1 rounded cursor-pointer" 
                                              onclick="copyToClipboard('{{' + variable.name + '}}')" 
                                              title="点击复制">
                                            ${variable.name}
                                        </code>
                                                    </td>
                                                    <td class="border-0">
                                                        <span class="badge bg-secondary bg-opacity-75">${variable.data_type}</span>
                                                    </td>
                                                    <td class="border-0">
                                                        ${variable.is_required ? 
                                                            '<span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>必填</span>' : 
                                                            '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>可选</span>'
                                                        }
                                                    </td>
                                                    <td class="border-0">
                                                        <small class="text-muted">${variable.example_value || '-'}</small>
                                                    </td>
                                                    <td class="border-0">
                                                        <small class="text-muted">${variable.description || '-'}</small>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div class="text-center py-5">
                                    <i class="bi bi-code-slash text-muted" style="font-size: 3rem;"></i>
                                    <h5 class="mt-3 text-muted">暂无变量</h5>
                                    <p class="text-muted">该模板中未检测到任何变量</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .bg-gradient-primary {
                background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
            }
            .cursor-pointer {
                cursor: pointer;
            }
            .variable-name:hover {
                background-color: var(--bs-primary) !important;
                color: white !important;
                transform: scale(1.05);
                transition: all 0.2s ease;
            }
        </style>
    `;
    
    document.getElementById('templateDetailContent').innerHTML = content;
    
    // 显示下载按钮并绑定点击事件
    const downloadBtn = document.getElementById('downloadTemplateBtn');
    downloadBtn.style.display = 'inline-block';
    downloadBtn.onclick = function() {
        downloadTemplate(template.id);
    };
    
    // 显示下载数据导入模板按钮并绑定点击事件
    const downloadDataBtn = document.getElementById('downloadDataTemplateBtn');
    downloadDataBtn.style.display = 'inline-block';
    downloadDataBtn.onclick = function() {
        downloadDataTemplate(template.id);
    };
}

function downloadTemplate(templateId) {
    // 创建下载链接
    const link = document.createElement('a');
    link.href = `/download_template/${templateId}`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function downloadDataTemplate(templateId) {
    // 创建下载数据导入模板链接
    const link = document.createElement('a');
    link.href = `/download_data_template/${templateId}`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // 创建临时提示
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 alert alert-success alert-dismissible fade show';
        toast.style.zIndex = '9999';
        toast.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>已复制到剪贴板: <code>${text}</code>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        
        // 3秒后自动移除
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }).catch(function(err) {
        console.error('复制失败:', err);
        alert('复制失败，请手动复制');
    });
}

function deleteTemplate(templateId) {
    if (confirm('确定要删除这个模板吗？删除后无法恢复！')) {
        // 显示删除中状态
        const deleteBtn = event.target;
        const originalText = deleteBtn.innerHTML;
        deleteBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 删除中...';
        deleteBtn.disabled = true;
        
        fetch(`/delete_template/${templateId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('模板删除成功！');
                location.reload();
            } else {
                alert('删除失败: ' + data.message);
                // 恢复按钮状态
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败: ' + error.message);
            // 恢复按钮状态
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        });
    }
}
</script>
{% endblock %}