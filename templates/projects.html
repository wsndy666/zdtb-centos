{% extends "base.html" %}

{% block title %}项目管理 - 智汇填报{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">项目管理</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-secondary" onclick="exportProjects()">
                <i class="bi bi-download"></i> 批量模板下载
            </button>
            <button type="button" class="btn btn-outline-warning" onclick="batchManage()">
                <i class="bi bi-list-check"></i> 批量管理
            </button>

        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th>项目ID</th>
                <th>填报项目名称</th>
                <th>备注</th>
                <th>创建时间</th>
                <th>关联模板</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% if projects %}
                {% for project in projects %}
                <tr>
                    <td>
                        <input type="checkbox" name="project_ids" value="{{ project[0] }}" onchange="updateSelectAll()">
                    </td>
                    <td><strong>P{{ "%03d"|format(project[0]) }}</strong></td>
                    <td>{{ project[1] }}</td>
                    <td>
                        {% if project[2] %}
                            <code>{{ project[2] }}</code>
                        {% else %}
                            <span class="text-muted">未设置</span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">{{ project[3] }}</small>
                    </td>
                    <td>
                        <span class="badge bg-info">{{ project[4] }} 个模板</span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="viewProject({{ project[0] }})">
                                <i class="bi bi-eye"></i> 查看
                            </button>

                            <button class="btn btn-outline-danger" onclick="deleteProject({{ project[0] }})">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-folder-x" style="font-size: 2rem;"></i><br>
                        暂无项目数据<br>
                        <small>点击"新建项目"开始创建</small>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- 项目详情模态框 -->
<div class="modal fade" id="projectDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">项目详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="projectDetailContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
function viewProject(projectId) {
    fetch(`/project/${projectId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayProjectDetail(data.project);
                $('#projectDetailModal').modal('show');
            } else {
                alert('获取项目信息失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取项目信息失败');
        });
}

function displayProjectDetail(project) {
    const content = document.getElementById('projectDetailContent');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <h6>基本信息</h6>
                <table class="table table-sm">
                    <tr><td><strong>项目ID:</strong></td><td>P${String(project.id).padStart(3, '0')}</td></tr>
                    <tr><td><strong>填报项目名称:</strong></td><td>${project.name}</td></tr>
                    <tr><td><strong>备注说明:</strong></td><td>${project.contract_number || '未设置'}</td></tr>
                    <tr><td><strong>创建时间:</strong></td><td>${project.created_at}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>项目数据</h6>
                <table class="table table-sm">
    `;
    
    if (Object.keys(project.data).length > 0) {
        for (const [key, value] of Object.entries(project.data)) {
            html += `<tr><td><strong>${key}:</strong></td><td>${value}</td></tr>`;
        }
    } else {
        html += '<tr><td colspan="2" class="text-muted">暂无项目数据</td></tr>';
    }
    
    html += `
                </table>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
}





function deleteProject(projectId) {
    if (confirm('确定要删除这个项目吗？删除后无法恢复。')) {
        fetch(`/delete_project/${projectId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('项目删除成功！');
                location.reload();
            } else {
                alert('删除失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败');
        });
    }
}

function exportProjects() {
    window.location.href = '/export_projects';
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const projectCheckboxes = document.querySelectorAll('input[name="project_ids"]');
    
    projectCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

function updateSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const projectCheckboxes = document.querySelectorAll('input[name="project_ids"]');
    const checkedBoxes = document.querySelectorAll('input[name="project_ids"]:checked');
    
    selectAllCheckbox.checked = projectCheckboxes.length === checkedBoxes.length;
    selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < projectCheckboxes.length;
}

function executeBatchAction(action, projectIds) {
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('batchModal'));
    modal.hide();
    
    switch(action) {
         case 'delete':
             if (confirm(`确定要删除选中的 ${projectIds.length} 个项目吗？此操作不可撤销！`)) {
                 batchDeleteProjects(projectIds);
             }
             break;
         case 'generate':
             batchGenerateFiles(projectIds);
             break;
     }
}

function batchDeleteProjects(projectIds) {
    const promises = projectIds.map(id => 
        fetch(`/delete_project/${id}`, { method: 'DELETE' })
            .then(response => response.json())
    );
    
    Promise.all(promises)
        .then(results => {
            const successCount = results.filter(r => r.success).length;
            const failCount = results.length - successCount;
            
            if (failCount === 0) {
                alert(`成功删除 ${successCount} 个项目`);
            } else {
                alert(`删除完成：成功 ${successCount} 个，失败 ${failCount} 个`);
            }
            location.reload();
        })
        .catch(error => {
            console.error('批量删除失败:', error);
            alert('批量删除失败，请稍后重试');
        });
}

function batchGenerateFiles(projectIds) {
     if (confirm(`确定要为选中的 ${projectIds.length} 个项目批量生成文件吗？`)) {
         // 显示加载状态
         const loadingAlert = document.createElement('div');
         loadingAlert.className = 'alert alert-info';
         loadingAlert.innerHTML = '<i class="bi bi-hourglass-split"></i> 正在批量生成文件，请稍候...';
         document.body.insertBefore(loadingAlert, document.body.firstChild);
         
         fetch('/batch_generate_files', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json'
             },
             body: JSON.stringify({ project_ids: projectIds })
         })
         .then(response => response.json())
         .then(data => {
             loadingAlert.remove();
             if (data.success) {
                 alert(`批量生成文件完成！\n成功: ${data.success_count} 个项目\n失败: ${data.fail_count} 个项目\n生成的文件已保存到输出目录`);
                 if (data.download_url) {
                     window.location.href = data.download_url;
                 }
             } else {
                 alert('批量生成文件失败：' + data.message);
             }
         })
         .catch(error => {
             loadingAlert.remove();
             console.error('批量生成文件失败:', error);
             alert('批量生成文件失败，请稍后重试');
         });
     }
 }

function batchManage() {
    // 获取所有选中的项目
    const checkboxes = document.querySelectorAll('input[name="project_ids"]:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('请先选择要批量管理的项目');
        return;
    }
    
    // 显示批量操作选项
     const actions = [
         { text: '批量删除', value: 'delete', class: 'btn-danger' },
         { text: '批量成文件', value: 'generate', class: 'btn-success' }
     ];
    
    let actionHtml = '<div class="modal fade" id="batchModal" tabindex="-1">\n';
    actionHtml += '<div class="modal-dialog">\n';
    actionHtml += '<div class="modal-content">\n';
    actionHtml += '<div class="modal-header">\n';
    actionHtml += '<h5 class="modal-title">批量管理 - 已选择 ' + selectedIds.length + ' 个项目</h5>\n';
    actionHtml += '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n';
    actionHtml += '</div>\n';
    actionHtml += '<div class="modal-body">\n';
    actionHtml += '<p>请选择要执行的批量操作：</p>\n';
    
    actions.forEach(action => {
        actionHtml += `<button type="button" class="btn ${action.class} me-2 mb-2" onclick="executeBatchAction('${action.value}', [${selectedIds.join(',')}])">${action.text}</button>\n`;
    });
    
    actionHtml += '</div>\n';
    actionHtml += '</div>\n';
    actionHtml += '</div>\n';
    actionHtml += '</div>';
    
    // 移除已存在的模态框
    const existingModal = document.getElementById('batchModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新的模态框
    document.body.insertAdjacentHTML('beforeend', actionHtml);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('batchModal'));
    modal.show();
}
</script>
{% endblock %}