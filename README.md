# 智汇填报系统 v1.3.0

一个基于Flask的自动化文档填报系统，支持Word和Excel模板的变量替换和批量文件生成。集成了完整的用户认证系统和权限管理功能。

## 功能特性

### 核心功能
- **模板管理**：支持上传Word(.docx)和Excel(.xlsx)模板文件
- **变量系统**：自动提取模板中的变量占位符，支持变量复用
- **项目管理**：创建项目并关联变量数据
- **批量生成**：一键生成多个项目的所有模板文件
- **数据导入**：支持Excel批量导入项目数据
- **操作日志**：记录所有系统操作，支持日志导出
- **本地化部署**：完全离线运行，数据安全可控

### 用户认证与权限管理
- **用户注册登录**：支持用户注册、登录、登出功能
- **密码安全**：密码复杂度验证、哈希存储、支持密码修改
- **账户安全**：登录失败锁定机制，防止暴力破解
- **权限管理**：基于角色的权限控制（管理员/普通用户）
- **用户管理**：管理员可管理所有用户账户状态
- **会话管理**：安全的用户会话控制

## 技术栈

- **后端**：Python 3.8+, Flask 2.3.3
- **数据库**：SQLite 3
- **前端**：Bootstrap 5.3, 原生JavaScript（已移除jQuery依赖）
- **文档处理**：python-docx, openpyxl
- **数据处理**：pandas
- **安全认证**：hashlib（密码哈希）, 会话管理
- **打包工具**：PyInstaller

## 核心功能详解

### 1. 导出文件命名规则

系统采用智能命名策略，确保文件名清晰且避免冲突：

#### 单个项目文件生成
- **命名格式**：`{项目名称}_{模板名称}{文件扩展名}`
- **示例**：项目"办公用品采购"使用模板"合同模板.docx" → `办公用品采购_合同模板.docx`
- **路径结构**：`output/P001/合同模板/办公用品采购_合同模板.docx`

#### 批量项目文件生成
- **命名格式**：`{模板名称}{文件扩展名}`
- **示例**：使用模板"付款通知书.docx" → `付款通知书.docx`
- **路径结构**：`output/P001/付款通知书/付款通知书.docx`

#### 目录组织结构

```
报账001/
├── app.py                 # 主应用文件
├── requirements.txt       # Python依赖包
├── README.md             # 说明文档
├── templates/            # HTML模板目录
│   ├── base.html        # 基础模板
│   ├── index.html       # 首页
│   ├── templates.html   # 模板管理页面
│   ├── variables.html   # 变量管理页面
│   ├── projects.html    # 项目管理页面
│   └── logs.html        # 操作日志页面
├── uploads/             # 上传文件目录（自动创建）
├── output/              # 生成文件目录（自动创建）
└── database.db          # SQLite数据库（自动创建）
```

## 数据库结构

系统使用SQLite数据库，包含以下表：

### 核心业务表
- `variables`：变量定义表
- `templates`：模板信息表
- `projects`：项目基本信息表
- `project_data`：项目数据表
- `template_variables`：模板变量关联表
- `operation_logs`：操作日志表

### 用户认证表
- `users`：用户账户表（用户名、密码哈希、邮箱、角色等）
- `permissions`：权限定义表
- `role_permissions`：角色权限关联表

## 使用说明

### 首次使用
1. 启动系统后，访问注册页面创建管理员账户
2. 使用管理员账户登录系统
3. 在用户管理页面可以创建其他用户账户

### 默认管理员账户
- 用户名：admin
- 密码：Admin123!
- 邮箱：admin@example.com

### 注意事项
1. **模板格式**：模板中的变量必须使用 `{{变量名}}` 格式
2. **文件大小**：上传文件大小限制为16MB
3. **数据备份**：建议定期备份 `system.db` 文件
4. **安全性**：生产环境请修改 `app.py` 中的 `SECRET_KEY`
5. **密码要求**：密码至少8位，必须包含大小写字母、数字和特殊字符
6. **账户安全**：连续登录失败5次将锁定账户10分钟

## 故障排除

### 常见问题

1. **模块导入错误**：确保已安装所有依赖包
2. **文件上传失败**：检查文件大小和格式
3. **变量识别失败**：确认模板中变量格式正确
4. **生成文件失败**：检查项目数据是否完整

### 日志查看

系统运行日志会显示在控制台，可以通过日志信息排查问题。

## 开发说明

如需二次开发，请参考以下信息：

- Flask路由定义在 `app.py` 中
- 前端模板使用Jinja2语法
- 数据库操作使用原生SQL
- 文档处理使用python-docx和openpyxl库

## 版本更新记录

### v1.3.0 (2025-08-10)

**重大更新：**
- ✅ 新增完整的用户认证系统（注册、登录、登出）
- ✅ 实现基于角色的权限管理（管理员/普通用户）
- ✅ 新增用户管理功能（管理员可管理所有用户）
- ✅ 新增密码修改功能，支持密码复杂度验证
- ✅ 实现账户安全机制（登录失败锁定）
- ✅ 优化操作日志记录，正确显示操作用户

**技术改进：**
- 移除jQuery依赖，全面转换为原生JavaScript
- 提升页面加载性能和兼容性
- 改进前端交互体验
- 增强系统安全性

**修复问题：**
- 修复用户管理页面jQuery未定义错误
- 修复注册页面400错误问题
- 修复数据库锁定问题
- 修复操作日志显示"系统用户"的问题

### v1.2.0 (2025-08-02)

**功能增强：**
- ✅ 新增系统激活码验证机制
- ✅ 完善系统打包和分发流程
- ✅ 优化用户界面和交互体验

### v1.1.0 (2025-07-27)

**新增功能：**
- ✅ 修复模板上传时间显示问题（UTC时间转本地时间）
- ✅ 修复项目创建和更新时间显示问题
- ✅ 打包程序增加数据库清理功能，确保分发包数据库干净
- ✅ 优化时间记录逻辑，统一使用本地时间

**技术改进：**
- 所有时间字段现在正确显示本地时间（东八区）
- 打包前自动备份并清理数据库数据
- 保持数据库结构完整，仅清理用户数据
- 改进打包流程，确保分发包质量

**修复问题：**
- 修复模板上传时间比实际时间少8小时的问题
- 修复项目创建时间显示不准确的问题
- 修复数据库时间记录不一致的问题

### v1.0.0 (2024年)

**初始版本功能：**
- 基础的模板管理功能
- 项目数据管理
- 文件生成功能
- 变量管理
- 操作日志记录

## 安全特性

### 密码安全
- 密码使用SHA-256哈希算法加密存储
- 支持密码复杂度验证（大小写字母、数字、特殊字符）
- 提供密码修改功能

### 账户安全
- 登录失败5次自动锁定账户10分钟
- 会话超时自动登出
- 防止SQL注入和XSS攻击

### 权限控制
- 基于角色的访问控制（RBAC）
- 管理员权限：用户管理、系统配置
- 普通用户权限：基础功能使用

## 版本信息

- 当前版本：1.3.0
- 更新日期：2025-08-10
- 开发者：AI Assistant